<!doctype html>
<html lang="en">
 
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="kunhwa_icon.ico">
  <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.css">
  <link rel="stylesheet" href="https://unpkg.com/inspire-tree-dom@4.0.6/dist/inspire-tree-light.min.css">
  <link rel="stylesheet" href="/main.css">
  <link href="https://fonts.googleapis.com/css?family=Nanum+Gothic:700&display=swap" rel="stylesheet">
  <title>Kunhwa Platform Services</title>
 
  <!-- AI UI ì „ìš© (ì„ì‹œ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼) -->
  <style>
    /* ì´ˆê¸° ìƒíƒœ ì œì–´: data-open=true ì—ì„œë§Œ ë³´ì´ë„ë¡ */
    #chatBox { display: none; }
    #chatBox[data-open="true"] { display: flex; }
 
    /* í”Œë¡œíŒ… KH CI ë²„íŠ¼ â€” ë””ìì¸ A(í™”ì´íŠ¸ ë²„íŠ¼) */
    .kh-ci-btn {
      position: fixed;
      bottom: 22px;
      right: 22px;
      width: 56px;
      height: 56px;
      border: 1px solid #e5e7eb;
      border-radius: 50%;
      background: #ffffff;               /* í™”ì´íŠ¸ ë°°ê²½ â†’ ë¡œê³  í° ë°°ê²½ê³¼ ìì—°ìŠ¤ëŸ½ê²Œ */
      box-shadow: 0 10px 24px rgba(0,0,0,0.18);
      cursor: pointer;
      z-index: 1000;
      display: flex; align-items: center; justify-content: center;
      padding: 0;
    }
    .kh-ci-btn:focus { outline: none; }
    .kh-ci-img { width: 30px; height: 30px; display: block; }
 
    /* ì±„íŒ…ì°½ ì»¨í…Œì´ë„ˆ */
    #chatBox {
      position: fixed;
      top: 4em;
      right: 0;
      bottom: 0;
      width: var(--chat-panel-current);
      background: #fff;
      border-radius: 0;
      border-left: 1px solid #e5e7eb;
      box-shadow: -16px 0 32px rgba(0,0,0,0.22);
      overflow: hidden;
      flex-direction: column;
      z-index: 1000;
    }

    body.chat-open #chatBox {
      display: flex;
    }

    body.chat-open #openChatBtn {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
 
    /* í—¤ë” */
    #chatBox .chat-header {
      height: 44px;
      background: #111827;
      color: #fff;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 12px;
      font-weight: 700;
      font-size: 14px;
    }
    #chatBox .close-btn {
      background: transparent; border: 0; color: #fff; font-size: 22px; cursor: pointer;
    }
 
    /* í—¤ë” ìœ í‹¸ */
    #chatBox .header-utils {
      background: #f3f4f6;
      padding: 6px 10px;
      font-size: 12px;
      color: #374151;
      display: flex; align-items: center; gap: 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    #chatBox .header-utils button {
      background: #fff; border: 1px solid #e5e7eb; border-radius: 6px;
      padding: 4px 8px; cursor: pointer; font-size: 12px;
    }
    #chatBox .header-utils .sep { color: #9ca3af; }
    #chatBox .status-pill {
      margin-left: auto;
      padding: 2px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 11px;
      color: #0f172a;
      background: #dbeafe;
      border: 1px solid #bfdbfe;
    }
    #chatBox .status-pill[data-state="busy"] {
      background: #fde68a;
      border-color: #fcd34d;
      color: #78350f;
    }
 
    /* ë‚ ì§œ ì˜ì—­ */
    #chatBox .chat-date {
      padding: 8px 12px;
      border-bottom: 1px solid #e5e7eb;
      background: #fafafa;
    }
    #chatBox .date-row { display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }
    #chatBox .date-icon { width: 18px; height: 18px; }
    #chatBox .date-title { font-weight: 700; color: #111827; font-size: 13px; }
    #chatBox .date-text { color: #6b7280; font-size: 12px; }
 
    /* ë©”ì‹œì§€ ì˜ì—­ */
    #chatArea {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      background: #ffffff;
    }
 
    /* ì…ë ¥ ì˜ì—­ */
    #chatBox .chat-input-row {
      display: flex; align-items: center; gap: 8px;
      padding: 8px;
      border-top: 1px solid #e5e7eb;
      background: #fafafa;
    }
    #chatBox .file-btn {
      width: 32px; height: 32px; border-radius: 6px; border: 1px solid #e5e7eb; background: #fff; cursor: pointer;
    }
    #fileInput { display: none; }
    #chatBox .input-box {
      flex: 1; height: 34px; border: 1px solid #e5e7eb; border-radius: 6px; padding: 0 10px; outline: none;
    }
    #chatBox .send-btn {
      width: 38px; height: 38px; border-radius: 50%; border: none; background: #111827; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
 
    /* ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ (í–¥í›„ ê¸°ëŠ¥ìš©) */
    #chatBox .resize-handle {
      position: absolute; width: 16px; height: 16px; right: 4px; bottom: 4px;
      background: linear-gradient(135deg, transparent 50%, #d1d5db 50%);
      pointer-events: none;
    }
 
    /* ë°˜ì‘í˜• */
    @media (max-width: 640px) {
      #chatBox {
        width: calc(100% - 32px);
        left: 16px;
        right: 16px;
        top: 4em;
        height: calc(100vh - 4em - 24px);
        border-radius: 16px;
      }
    }
 
    /* ë””ìì¸ B(íŒŒë€ ì› ë²„íŠ¼)ë¡œ ë°”ê¾¸ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ë¥¼ ëŒ€ì‹  ì‚¬ìš©
    .kh-ci-btn {
      background: #0ea5e9; border: none;
    }
    .kh-ci-img { width: 30px; height: 30px; border-radius: 50%; overflow: hidden; }
    */
  </style>
  <!-- Kakao-style chat overrides -->
  <style>
    #chatBox {
      background: linear-gradient(180deg, #f7f8fb 0%, #f2f3f7 100%);
      border-left: 1px solid #e5e7eb;
      box-shadow: -16px 0 32px rgba(0,0,0,0.22);
    }

    #chatBox .chat-header {
      height: 48px;
      padding: 0 14px;
      letter-spacing: -0.01em;
    }

    #chatBox .header-utils {
      padding: 8px 12px;
      gap: 8px;
    }
    #chatBox .header-utils button {
      border-radius: 8px;
      padding: 5px 10px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.04);
    }
    #chatBox .status-pill {
      padding: 3px 12px;
    }

    #chatArea {
      flex: 1;
      padding: 14px 14px 18px 14px;
      background: transparent;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-thread {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chat-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }
    .chat-row.assistant { justify-content: flex-start; }
    .chat-row.user { justify-content: flex-end; }

    .chat-avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: #fff;
      border: 1px solid #e5e7eb;
      display: grid;
      place-items: center;
      font-size: 11px;
      font-weight: 700;
      color: #111827;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
    }
    .chat-avatar.assistant {
      background: #e5e7eb;
      color: #111827;
      border-color: #d1d5db;
    }

    .chat-bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 18px;
      font-size: 13px;
      line-height: 1.5;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .chat-row.assistant .chat-bubble {
      background: #f2f3f5;
      color: #111827;
      border-top-left-radius: 8px;
      border-top-right-radius: 18px;
    }
    .chat-row.user .chat-bubble {
      background: #ffe84a;
      color: #111827;
      border-top-right-radius: 8px;
      border-top-left-radius: 18px;
    }

    .chat-sources {
      margin: 8px 0 0 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .chat-sources li {
      font-size: 12px;
      color: #4b5563;
      background: #e5e7eb;
      border-radius: 10px;
      padding: 6px 8px;
    }

    .chat-loading {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .chat-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #9ca3af;
      animation: blink 1s ease-in-out infinite;
    }
    .chat-dot:nth-child(2) { animation-delay: 0.15s; }
    .chat-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes blink {
      0%, 100% { opacity: 0.2; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-2px); }
    }

    #chatBox .chat-input-row {
      gap: 10px;
      padding: 10px 12px;
      background: #f8f9fb;
    }
    #chatBox .file-btn {
      width: 36px; height: 36px; border-radius: 10px; border: 1px solid #e5e7eb; background: #fff;
      box-shadow: 0 6px 12px rgba(0,0,0,0.05);
    }
    #chatBox .input-box {
      height: 38px; border-radius: 12px; padding: 0 12px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }
    #chatBox .send-btn {
      width: 40px; height: 40px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    #chatBox .send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0,0,0,0.16);
    }

    @media (max-width: 640px) {
      .chat-bubble { max-width: 82%; }
    }
  </style>
</head>
 
<script type="module" src="/assistant-frontend.js"></script>
 
<body>
  <!-- ê¸°ì¡´ í—¤ë”/íŠ¸ë¦¬/ë·°ì–´ -->
  <div id="header">
    <img class="logo" src="KH_logo.png" alt="Kunhwa">
    <span class="title">Kunhwa Platform Service</span>
    <button id="login" style="visibility: hidden;">Login</button>
  </div>
  <div id="sidebar"><div id="tree"></div></div>
  <div id="sidebarResizer" role="separator" aria-label="í”„ë¡œì íŠ¸ íŠ¸ë¦¬ í¬ê¸° ì¡°ì ˆ"></div>
  <div id="preview"></div>
  <!-- Viewer Container -->
  <div id="viewerContainer"></div>

  <!-- âœ… Bottom Summary Panel -->
  <div id="bottomSummaryPanel" class="bottom-summary-panel hidden">
    <div class="bottom-summary-header">
      <div>
        <div id="bottomSummaryTitle" class="bottom-summary-title">ìš”ì•½ í‘œ</div>
        <div id="bottomSummaryDesc" class="bottom-summary-desc"></div>
      </div>
      <button id="bottomSummaryClose" class="bottom-summary-close">ë‹«ê¸°</button>
    </div>

    <div id="bottomSummaryTableWrap" class="bottom-summary-table-wrap"></div>
  </div>

  <div id="quickActions" class="quick-actions" aria-label="ëª¨ë¸ ë¹ ë¥¸ í•„í„°">
    <button id="btnResetView" type="button">ì „ì²´ ëª¨ë¸ ë³´ê¸°</button>
    <div class="category-filter">
      <label for="categoryFilterSelect" class="sr-only">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
      <select id="categoryFilterSelect" aria-label="ëª¨ë¸ ì¹´í…Œê³ ë¦¬ ì„ íƒ">
        <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
      <button id="btnApplyCategory" type="button">ì„ íƒ ì¹´í…Œê³ ë¦¬ ë³´ê¸°</button>
    </div>
    <button id="btnExportMeta" type="button" style="margin-left: 8px; background:#4b5563; color:white; border:none; border-radius:4px; cursor:pointer;">
      ğŸ“¥ AI í•™ìŠµìš© ë°ì´í„° ì¶”ì¶œ
    </button>
  </div>

  <!-- Schedule Table Panel -->
  <section id="schedulePanel" aria-live="polite" data-visible="false">
    <div class="schedule-header">
      <div class="schedule-text">
        <div id="scheduleTitle">ì¼ëŒí‘œ</div>
        <div id="scheduleDescription">ìš”ì²­í•œ í‘œ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
      <div class="schedule-actions">
        <button id="scheduleCollapseBtn" type="button" aria-label="í‘œ ì ‘ê¸°">ì ‘ê¸°</button>
        <button id="scheduleCloseBtn" type="button" aria-label="í‘œ ë‹«ê¸°">ë‹«ê¸°</button>
      </div>
    </div>
    <div class="schedule-body">
      <div class="schedule-table-wrapper">
        <table>
          <thead id="scheduleTableHead"></thead>
          <tbody id="scheduleTableBody"></tbody>
        </table>
        <div id="scheduleEmptyState">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </div>
  </section>
 
  <!-- KH CI ì•„ì´ì½˜ ë²„íŠ¼ -->
  <button id="openChatBtn" class="kh-ci-btn" title="AI íŒŒíŠ¸ë„ˆ ì—´ê¸°" aria-label="AI Partner">
    <img src="kunhwa_icon-7.png" alt="Kunhwa ì•„ì´ì½˜" class="kh-ci-img">
  </button>
 
  <div id="chatResizer" role="separator" aria-label="AI ëŒ€í™”ì°½ í¬ê¸° ì¡°ì ˆ"></div>
  <!-- AI ëŒ€í™”ì°½ (ì´ˆê¸° ë‹«í˜: data-open=false) -->
  <div id="chatBox" role="dialog" aria-modal="false" aria-label="R&D Center Assistant" data-open="false">
    <div class="chat-header">
      <span class="header-left">Kunhwa AI íŒŒíŠ¸ë„ˆ</span>
      <button class="close-btn" title="ë‹«ê¸°" aria-label="Close">&times;</button>
    </div>
 
    <div class="header-utils">
      <button id="restartBtn" title="ì±„íŒ… ë‹¤ì‹œ ì‹œì‘" type="button">âŸ³ ì±„íŒ… ë‹¤ì‹œ ì‹œì‘</button>
      <span class="sep">|</span>
      <button id="endBtn" title="ì±„íŒ… ì¢…ë£Œ" type="button">âœ– ì±„íŒ… ì¢…ë£Œ</button>
      <span id="chatStatus" class="status-pill" data-state="idle">ì¤€ë¹„ ì™„ë£Œ</span>
    </div>
 
    <div class="chat-date" id="chatDate">
      <div class="date-row">
        <img src="kunhwa_icon-7.png" alt="date-icon" class="date-icon">
        <span class="date-title">KH AI í—¬í”„ë°ìŠ¤í¬</span>
      </div>
      <div class="date-text" id="dateText"></div>
    </div>
 
    <div id="chatArea">
      <div style="color:#9ca3af;font-size:13px;">â€» ì´í›„ ì—°ê²° ì‹œ ì—¬ê¸°ì— ëŒ€í™”ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>
 
    <form id="chatForm" autocomplete="off">
      <div class="chat-input-row">
        <button type="button" class="file-btn" id="fileBtn" title="íŒŒì¼ ì²¨ë¶€">+</button>
        <input type="file" id="fileInput" accept="image/*,.csv,.txt,.pdf">
        <input type="text" id="userInput" class="input-box" placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”" autocomplete="off">
        <button type="submit" class="send-btn" id="sendBtn" title="ì „ì†¡">
          <svg width="27" height="27" viewBox="0 0 28 28" fill="none" aria-hidden="true">
            <circle cx="14" cy="14" r="13" fill="black"/>
            <path d="M14 20V12M14 12l-4 4m4-4l4 4" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </form>
 
    <div class="resize-handle"></div>
  </div>
 
  <!-- ë·°ì–´/íŠ¸ë¦¬ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <script src="https://unpkg.com/inspire-tree@4.3.1/dist/inspire-tree.js"></script>
  <script src="https://unpkg.com/inspire-tree-dom@4.0.6/dist/inspire-tree-dom.min.js"></script>
  <script src="/main.js" type="module"></script>
 
    <!-- AI UI ?? -->
  <script>
    (function () {
      const $btn     = document.getElementById('openChatBtn');
      const $box     = document.getElementById('chatBox');
      const $close   = $box?.querySelector('.close-btn');
      const $dateTxt = document.getElementById('dateText');
      const $restart = document.getElementById('restartBtn');
      const $end     = document.getElementById('endBtn');

      function setDate() {
        const now = new Date();
        const fmt = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        if ($dateTxt) $dateTxt.textContent = fmt;
      }
      setDate();

      function openChat()  {
        $box?.setAttribute('data-open', 'true');
        document.body?.classList.add('chat-open');
      }
      function closeChat() {
        $box?.setAttribute('data-open', 'false');
        document.body?.classList.remove('chat-open');
      }
      function toggleChat() {
        if (!$box) return;
        const isOpen = $box.getAttribute('data-open') === 'true';
        isOpen ? closeChat() : openChat();
      }

      $btn?.addEventListener('click', toggleChat);
      $close?.addEventListener('click', closeChat);
      $end?.addEventListener('click', closeChat);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeChat();
      });

      // ??? ?? ?? ? ??? ?? (?? ???? assistant-frontend.js ??)
      $restart?.addEventListener('click', () => setDate());
    })();
  </script>

</body>
</html>
